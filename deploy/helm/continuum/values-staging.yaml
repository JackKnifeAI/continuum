# CONTINUUM Staging Environment Values
# Overrides for deploy/helm/continuum/values.yaml
#
# Usage:
#   helm upgrade --install continuum ./deploy/helm/continuum \
#     --namespace continuum-staging \
#     --values deploy/helm/continuum/values-staging.yaml

# =============================================================================
# IMAGE - Use staging tag
# =============================================================================
image:
  repository: jackknifeai/continuum
  pullPolicy: Always  # Always pull latest staging image
  tag: "v1.0.0-staging"

# =============================================================================
# DEPLOYMENT - Reduced resources for staging
# =============================================================================
replicaCount: 2  # vs 3 in production

strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0  # No downtime during updates

# =============================================================================
# RESOURCES - Smaller footprint
# =============================================================================
resources:
  limits:
    cpu: 1000m      # vs 2000m in production
    memory: 1Gi     # vs 2Gi in production
  requests:
    cpu: 250m       # vs 500m in production
    memory: 256Mi   # vs 512Mi in production

# =============================================================================
# AUTOSCALING - More conservative
# =============================================================================
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5     # vs 20 in production
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
        - type: Pods
          value: 2
          periodSeconds: 30

# =============================================================================
# PERSISTENCE - Smaller storage
# =============================================================================
persistence:
  enabled: true
  storageClassName: standard  # Use cheaper storage class
  accessModes:
    - ReadWriteMany
  size: 5Gi  # vs 10Gi in production
  annotations: {}

# =============================================================================
# SERVICE
# =============================================================================
service:
  type: ClusterIP
  port: 8420
  targetPort: 8420
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800

# =============================================================================
# INGRESS - Staging domain with Let's Encrypt staging
# =============================================================================
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-staging  # Use staging to avoid rate limits
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/websocket-services: continuum-api
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/rate-limit: "200"  # Higher for testing
  hosts:
    - host: staging.continuum.ai
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: continuum-staging-tls
      hosts:
        - staging.continuum.ai

# =============================================================================
# CONFIGURATION - Staging-specific settings
# =============================================================================
config:
  logLevel: debug  # More verbose logging in staging
  tenantId: staging-default

  # Database settings
  dbTimeout: 30.0
  hookTimeout: 4.5
  cacheTTL: 300

  # API settings
  apiPort: 8420
  corsOrigins: "*"  # Permissive for testing
  requireApiKey: true

  # Performance tuning (π×φ optimized)
  resonanceDecay: 0.85
  hebbianRate: 0.15
  minLinkStrength: 0.1
  workingMemoryCapacity: 7

  # Context budget
  totalContextTokens: 100000
  reservedForResponse: 8000
  reservedForSystem: 2000

  # Quality thresholds
  minConceptOccurrences: 2
  maxConceptsPerMessage: 20
  minConceptLength: 3
  maxConceptLength: 100

  # WebSocket
  wsHeartbeatInterval: 30
  wsTimeout: 90

  # Verification constant
  piPhi: 5.083203692315260

# =============================================================================
# SECRETS - Managed externally (Kubernetes secret)
# =============================================================================
secrets:
  # PostgreSQL staging database
  databaseUrl: "postgresql://continuum_staging:STAGING_PASSWORD@postgres-staging.internal:5432/continuum_staging"

  # API keys (generated during deployment)
  apiKeys: "GENERATED_BY_DEPLOYMENT_SCRIPT"

  # Stripe TEST keys (never use production keys in staging!)
  stripeSecretKey: "sk_test_51SOm0LK8ytHuMCAp1RnW25rcwcsemoEUGGO6qeHije4bReWG6SWZ4juxPY0Q3xIizZYTa66oSQROhBrD0je8Xk6y00Vv1EElvh"
  stripeWebhookSecret: "whsec_STAGING_WEBHOOK_SECRET"

  # JWT secret for session persistence
  jwtSecret: "GENERATED_BY_DEPLOYMENT_SCRIPT"

  # Federation secret
  federationSecret: "GENERATED_BY_DEPLOYMENT_SCRIPT"

  # External API keys (optional, test accounts)
  openaiApiKey: ""
  anthropicApiKey: ""

# =============================================================================
# FEDERATION - Reduced capacity for staging
# =============================================================================
federation:
  enabled: true
  replicaCount: 1  # vs 3 in production
  port: 8421

  resources:
    limits:
      cpu: 500m      # vs 1000m in production
      memory: 1Gi    # vs 2Gi in production
    requests:
      cpu: 125m      # vs 250m in production
      memory: 256Mi  # vs 512Mi in production

  persistence:
    enabled: true
    storageClassName: standard
    size: 10Gi  # vs 20Gi in production

  config:
    syncInterval: 60
    heartbeatInterval: 30
    maxRetries: 3
    timeout: 10
    gossipFanout: 2  # vs 3 in production
    gossipInterval: 5
    minConsensus: 1  # vs 2 in production (only 1 node)
    quorumSize: 1
    replicationFactor: 1
    consistencyLevel: eventual  # vs quorum in production

# =============================================================================
# MONITORING - Enabled for staging validation
# =============================================================================
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s

  prometheusRule:
    enabled: true

  grafanaDashboard:
    enabled: true

# =============================================================================
# POD DISRUPTION BUDGET - Relaxed for staging
# =============================================================================
podDisruptionBudget:
  enabled: true
  minAvailable: 1  # vs 2 in production

# =============================================================================
# AFFINITY - Less strict for staging
# =============================================================================
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 50  # vs 100 in production
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - continuum
          topologyKey: kubernetes.io/hostname

nodeSelector: {}
tolerations: []

# =============================================================================
# NETWORK POLICY - Staging-specific rules
# =============================================================================
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress

  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
        # Also allow traffic from monitoring namespace
        - namespaceSelector:
            matchLabels:
              name: monitoring

  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # Allow external API calls (Stripe, OpenAI, etc.)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

# =============================================================================
# INIT CONTAINERS - Run migrations
# =============================================================================
initContainers:
  migrations:
    enabled: true
    image: jackknifeai/continuum:v1.0.0-staging
    command:
      - python
      - -m
      - continuum.storage.migrations
      - migrate

# =============================================================================
# POD ANNOTATIONS - Staging-specific
# =============================================================================
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8420"
  prometheus.io/path: "/metrics"
  # Add staging marker
  environment: "staging"
  version: "v1.0.0-staging"

# =============================================================================
# POD SECURITY - Same as production
# =============================================================================
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000

# =============================================================================
# EXTERNAL SECRETS - Not used in staging (direct secrets)
# =============================================================================
externalSecrets:
  enabled: false

# =============================================================================
# STAGING-SPECIFIC ENVIRONMENT VARIABLES
# =============================================================================
extraEnv:
  - name: CONTINUUM_ENV
    value: "staging"
  - name: CONTINUUM_DEBUG
    value: "false"  # Debug mode off, but logLevel=debug
  - name: STRIPE_PUBLISHABLE_KEY
    value: "pk_test_STAGING_PUBLISHABLE_KEY"
  - name: SENTRY_ENVIRONMENT
    value: "staging"
  - name: SENTRY_DSN
    value: "https://STAGING_SENTRY_DSN@sentry.io/PROJECT_ID"
  - name: POSTHOG_API_KEY
    value: "phc_STAGING_POSTHOG_KEY"
  - name: POSTHOG_HOST
    value: "https://app.posthog.com"

# =============================================================================
# NOTES
# =============================================================================
# This configuration is optimized for:
# - Cost efficiency (smaller resources)
# - Testing and validation
# - Stripe test mode (no real charges)
# - Verbose logging (debug level)
# - Let's Encrypt staging (avoids rate limits)
#
# DO NOT use in production!
# For production, use default values.yaml
# =============================================================================
