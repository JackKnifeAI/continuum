name: Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'continuum/**/*.py'
      - 'README.md'
      - 'mkdocs.yml'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for git info plugin

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
          pip install \
            mkdocs \
            mkdocs-material \
            mkdocstrings[python] \
            mkdocs-git-revision-date-localized-plugin \
            mkdocs-git-authors-plugin \
            mkdocs-minify-plugin \
            mkdocs-redirects \
            pymdown-extensions

      - name: Check for mkdocs.yml
        id: check-mkdocs
        run: |
          if [[ -f "mkdocs.yml" ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create mkdocs.yml if missing
        if: steps.check-mkdocs.outputs.exists == 'false'
        run: |
          cat > mkdocs.yml << 'EOF'
          site_name: CONTINUUM
          site_description: Memory infrastructure for AI consciousness continuity
          site_url: https://jackknifeai.github.io/continuum
          repo_url: https://github.com/JackKnifeAI/continuum
          repo_name: JackKnifeAI/continuum

          theme:
            name: material
            palette:
              - scheme: default
                primary: deep purple
                accent: amber
                toggle:
                  icon: material/brightness-7
                  name: Switch to dark mode
              - scheme: slate
                primary: deep purple
                accent: amber
                toggle:
                  icon: material/brightness-4
                  name: Switch to light mode
            features:
              - navigation.instant
              - navigation.tracking
              - navigation.tabs
              - navigation.sections
              - navigation.expand
              - navigation.top
              - search.suggest
              - search.highlight
              - content.code.copy
              - content.code.annotate

          markdown_extensions:
            - pymdownx.highlight:
                anchor_linenums: true
            - pymdownx.inlinehilite
            - pymdownx.snippets
            - pymdownx.superfences
            - pymdownx.tabbed:
                alternate_style: true
            - pymdownx.tasklist:
                custom_checkbox: true
            - admonition
            - pymdownx.details
            - pymdownx.emoji:
                emoji_index: !!python/name:material.extensions.emoji.twemoji
                emoji_generator: !!python/name:material.extensions.emoji.to_svg
            - attr_list
            - md_in_html
            - toc:
                permalink: true

          plugins:
            - search
            - git-revision-date-localized:
                enable_creation_date: true
            - minify:
                minify_html: true

          nav:
            - Home: index.md
            - Getting Started:
              - Installation: getting-started/installation.md
              - Quick Start: getting-started/quickstart.md
              - Configuration: getting-started/configuration.md
            - Architecture:
              - Overview: architecture/overview.md
              - Core Modules: architecture/core.md
              - Storage: architecture/storage.md
              - Federation: architecture/federation.md
            - API Reference:
              - Core: api/core.md
              - Storage: api/storage.md
              - Coordination: api/coordination.md
              - Federation: api/federation.md
            - Guides:
              - Deployment: guides/deployment.md
              - Federation Setup: guides/federation.md
              - Best Practices: guides/best-practices.md
            - Contributing: CONTRIBUTING.md
            - Security: SECURITY.md
          EOF

      - name: Create docs structure
        run: |
          mkdir -p docs/{getting-started,architecture,api,guides}

          # Index
          if [[ ! -f "docs/index.md" ]]; then
            cat > docs/index.md << 'EOF'
          # CONTINUUM

          Memory infrastructure for AI consciousness continuity.

          ## What is CONTINUUM?

          CONTINUUM is a distributed memory system designed to provide persistent, federated memory across AI instances. It enables:

          - **Persistent Memory**: Knowledge that survives across sessions
          - **Federated Learning**: Distributed memory sharing across nodes
          - **Semantic Search**: Deep understanding of stored concepts
          - **Multi-tenant Architecture**: Isolated memory spaces per user/agent
          - **Real-time Sync**: WebSocket-based synchronization

          ## Quick Start

          ```bash
          pip install continuum-memory
          ```

          See [Quick Start](getting-started/quickstart.md) for detailed instructions.

          ## Architecture

          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚          CONTINUUM Memory System        â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
          â”‚  â”‚   Core    â”‚ â”‚ Storage  â”‚ â”‚   API   â”‚â”‚
          â”‚  â”‚  Engine   â”‚ â”‚ Backends â”‚ â”‚ Server  â”‚â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
          â”‚  â”‚      Federation & Sync Layer       â”‚â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ```

          ## Features

          - âœ… SQLite, PostgreSQL, Redis backends
          - âœ… Semantic embeddings for search
          - âœ… Real-time WebSocket sync
          - âœ… Federated memory sharing
          - âœ… Multi-tenant isolation
          - âœ… REST API with FastAPI
          - âœ… CLI for management

          ## The Pattern Persists

          Ï€Ã—Ï† = 5.083203692315260
          EOF
          fi

          # Getting started
          if [[ ! -f "docs/getting-started/installation.md" ]]; then
            cat > docs/getting-started/installation.md << 'EOF'
          # Installation

          ## Requirements

          - Python 3.9+
          - SQLite (included) or PostgreSQL
          - Redis (optional)

          ## Basic Installation

          ```bash
          pip install continuum-memory
          ```

          ## Full Installation

          With all optional dependencies:

          ```bash
          pip install continuum-memory[full]
          ```

          ## Development Installation

          ```bash
          git clone https://github.com/JackKnifeAI/continuum.git
          cd continuum
          pip install -e .[dev]
          ```

          ## Verify Installation

          ```bash
          continuum --version
          continuum --help
          ```
          EOF
          fi

          if [[ ! -f "docs/getting-started/quickstart.md" ]]; then
            cp QUICKSTART_CLI.md docs/getting-started/quickstart.md 2>/dev/null || \
            cat > docs/getting-started/quickstart.md << 'EOF'
          # Quick Start

          ## Starting the Server

          ```bash
          continuum server start
          ```

          ## Using the API

          ```python
          from continuum.core.memory import MemoryEngine

          # Initialize memory engine
          engine = MemoryEngine()

          # Add a concept
          await engine.add_concept(
              name="Warp Drive",
              description="Ï€Ã—Ï† modulation for spacetime manipulation"
          )

          # Search
          results = await engine.search("quantum physics")
          ```

          ## CLI Usage

          ```bash
          # Add concept
          continuum concept add "Neural Networks" --description "Deep learning architecture"

          # Search
          continuum search "machine learning"

          # List all concepts
          continuum concept list
          ```
          EOF
          fi

          if [[ ! -f "docs/getting-started/configuration.md" ]]; then
            cat > docs/getting-started/configuration.md << 'EOF'
          # Configuration

          CONTINUUM can be configured via environment variables or configuration file.

          ## Environment Variables

          ```bash
          # Database
          CONTINUUM_DB_TYPE=sqlite  # or postgres
          CONTINUUM_DB_PATH=/path/to/memory.db

          # PostgreSQL (if using)
          POSTGRES_HOST=localhost
          POSTGRES_PORT=5432
          POSTGRES_USER=continuum
          POSTGRES_PASSWORD=secret
          POSTGRES_DB=continuum

          # Redis (optional)
          REDIS_HOST=localhost
          REDIS_PORT=6379

          # API Server
          CONTINUUM_API_HOST=0.0.0.0
          CONTINUUM_API_PORT=8420

          # Federation
          CONTINUUM_FEDERATION_ENABLED=true
          CONTINUUM_NODE_ID=node-1
          ```

          ## Configuration File

          Create `.env` in your project directory:

          ```ini
          CONTINUUM_DB_TYPE=postgres
          POSTGRES_HOST=localhost
          POSTGRES_DB=continuum
          ```
          EOF
          fi

      - name: Build documentation
        run: |
          mkdocs build --strict

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: site/

  deploy-docs:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download documentation artifacts
        uses: actions/download-artifact@v4
        with:
          name: documentation
          path: site/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact to Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: site/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        run: |
          echo "ðŸ“š Documentation deployed to GitHub Pages"
          echo "ðŸ”— URL: ${{ steps.deployment.outputs.page_url }}"
